# 🚀 Долгосрочное решение проблем с сервером

## 📋 **Обзор проблемы**

Сервер периодически становится недоступным, а API зависает при регистрации пользователей. Диагностика показала, что проблема не в bcrypt или сетевом подключении, а в более глубоких системных проблемах.

## 🎯 **Стратегия решения**

### **Принцип: "Простота = Стабильность"**

Вместо сложных конфигураций с PostgreSQL и внешними зависимостями, используем:
- **SQLite** для базы данных (простота и надежность)
- **Redis** для кеширования (стабильность)
- **Автоматический мониторинг** для восстановления
- **Таймауты** для всех операций

## 🏗️ **Архитектура решения**

```
┌─────────────────────────────────────────────────────────────┐
│                    Стабильная система                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   FastAPI API   │    │   Redis Cache   │                │
│  │   (SQLite DB)   │◄──►│   (Persistent)  │                │
│  └─────────────────┘    └─────────────────┘                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Система мониторинга                        │ │
│  │  • Автоматическое восстановление                        │ │
│  │  • Проверка здоровья                                    │ │
│  │  • Логирование                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Systemd сервис                             │ │
│  │  • Автозапуск при перезагрузке                          │ │
│  │  • Автоматический перезапуск                            │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 📁 **Структура файлов**

```
/opt/fastapi-backend/
├── docker-compose.stable.yml          # Стабильная конфигурация
├── scripts/
│   ├── setup_stable.sh               # Установка стабильной версии
│   ├── monitor_and_restart.sh        # Скрипт мониторинга
│   └── cleaning-service-monitor.service # Systemd сервис
├── data/                             # Данные SQLite
├── logs/                             # Логи приложения
└── app/                              # Код приложения
```

## 🚀 **Установка**

### **1. Загрузка файлов на сервер**

```bash
# Загружаем стабильную конфигурацию
scp -i ~/.ssh/id_ed25519 docker-compose.stable.yml root@165.22.43.35:/opt/fastapi-backend/

# Загружаем скрипты
scp -i ~/.ssh/id_ed25519 scripts/setup_stable.sh root@165.22.43.35:/opt/fastapi-backend/scripts/
scp -i ~/.ssh/id_ed25519 scripts/monitor_and_restart.sh root@165.22.43.35:/opt/fastapi-backend/scripts/
scp -i ~/.ssh/id_ed25519 scripts/cleaning-service-monitor.service root@165.22.43.35:/opt/fastapi-backend/scripts/
```

### **2. Запуск установки**

```bash
ssh -i ~/.ssh/id_ed25519 root@165.22.43.35
cd /opt/fastapi-backend
chmod +x scripts/setup_stable.sh
./scripts/setup_stable.sh
```

## 🔧 **Конфигурация**

### **Основные параметры**

```yaml
# База данных
DATABASE_URL: sqlite:///./cleaning_service_stable.db

# Redis
REDIS_URL: redis://redis:6379

# Email (отключено)
EMAIL_VERIFICATION_REQUIRED: false

# Таймауты
REQUEST_TIMEOUT: 30
DATABASE_TIMEOUT: 10
REDIS_TIMEOUT: 5
```

### **Мониторинг**

- **Проверка каждые 60 секунд**
- **Автоматический перезапуск при проблемах**
- **Полный перезапуск после 3 неудачных попыток**
- **Логирование всех событий**

## 📊 **Мониторинг и управление**

### **Просмотр статуса**

```bash
# Статус сервисов
docker-compose -f /opt/fastapi-backend/docker-compose.stable.yml ps

# Статус мониторинга
systemctl status cleaning-service-monitor.service

# Логи мониторинга
journalctl -u cleaning-service-monitor.service -f

# Логи приложения
tail -f /var/log/cleaning_service_monitor.log
```

### **Управление**

```bash
# Перезапуск мониторинга
systemctl restart cleaning-service-monitor.service

# Перезапуск сервисов
cd /opt/fastapi-backend
docker-compose -f docker-compose.stable.yml restart

# Полная перезагрузка
docker-compose -f docker-compose.stable.yml down
docker-compose -f docker-compose.stable.yml up -d
```

## 🚨 **Устранение неполадок**

### **Сервер недоступен**

```bash
# Проверка SSH
ssh -i ~/.ssh/id_ed25519 root@165.22.43.35

# Если недоступен, перезагрузите сервер через панель управления
# После перезагрузки система автоматически восстановится
```

### **API не отвечает**

```bash
# Проверка контейнеров
docker ps

# Проверка логов
docker logs cleaning_service_api_stable

# Перезапуск API
docker restart cleaning_service_api_stable
```

### **Проблемы с базой данных**

```bash
# Проверка SQLite файла
ls -la /opt/fastapi-backend/data/

# Резервная копия
cp /opt/fastapi-backend/data/cleaning_service_stable.db /opt/fastapi-backend/data/backup_$(date +%Y%m%d_%H%M%S).db
```

## 📈 **Преимущества решения**

### **✅ Стабильность**
- SQLite не имеет проблем с сетевым подключением
- Автоматическое восстановление при сбоях
- Отсутствие внешних зависимостей

### **✅ Простота**
- Минимальная конфигурация
- Легкое понимание и отладка
- Быстрое восстановление

### **✅ Надежность**
- Автоматический мониторинг
- Логирование всех событий
- Автозапуск при перезагрузке

### **✅ Масштабируемость**
- Легко переключиться на PostgreSQL позже
- Возможность добавления новых сервисов
- Гибкая конфигурация

## 🔮 **Планы на будущее**

### **Краткосрочные (1-2 недели)**
- [ ] Мониторинг производительности
- [ ] Алерты при проблемах
- [ ] Автоматические резервные копии

### **Среднесрочные (1-2 месяца)**
- [ ] Миграция на PostgreSQL (опционально)
- [ ] Балансировщик нагрузки
- [ ] Кластеризация Redis

### **Долгосрочные (3-6 месяцев)**
- [ ] Kubernetes развертывание
- [ ] Микросервисная архитектура
- [ ] CI/CD пайплайн

## 📞 **Поддержка**

При возникновении проблем:

1. **Проверьте логи**: `journalctl -u cleaning-service-monitor.service -f`
2. **Проверьте статус**: `systemctl status cleaning-service-monitor.service`
3. **Перезапустите мониторинг**: `systemctl restart cleaning-service-monitor.service`
4. **Если не помогает**: Перезагрузите сервер

## 🎯 **Заключение**

Это решение обеспечивает:
- **Максимальную стабильность** через простоту
- **Автоматическое восстановление** при сбоях
- **Легкость управления** и мониторинга
- **Возможность развития** в будущем

**Простота = Стабильность = Надежность** 🚀
